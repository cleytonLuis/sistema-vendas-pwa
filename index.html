<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GK Suplementos</title>

    <link rel="manifest" href="manifest.json">
    
    <link rel="stylesheet" href="styles.css"> 
    
    <script>
        // 1. REGISTRO DO SERVICE WORKER (Executado imediatamente)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(reg => console.log('‚úÖ SW registrado com sucesso.'))
                    .catch(err => console.error('‚ùå Falha no registro do SW:', err));
            });
        }
        
        // 2. L√ìGICA DE REDIRECIONAMENTO CONTROLADO (Executado com atraso)
        function executeRedirection() {
            // Verifica se o app est√° rodando como um PWA instalado ('standalone')
            const isStandalone = (window.matchMedia('(display-mode: standalone)').matches) || (window.navigator.standalone);

            if (isStandalone) {
                // Se for modo App, n√£o redirecione. Deixe a aplica√ß√£o carregar normalmente.
                console.log('App rodando em modo Standalone. Redirecionamento para Tunnel ignorado.');
                return;
            }

            // Se for navega√ß√£o normal no browser, tente redirecionar para o Tunnel
            (async function() {
                try {
                    // Tenta ler o link din√¢mico do servidor Cloudflared
                    const res = await fetch('tunnel_link.json', {cache: "no-store"}); 
                    if (!res.ok) throw new Error('tunnel_link.json inacess√≠vel.');
                    
                    const config = await res.json();
                    const destino = config.app_url;

                    // Redireciona se a URL de destino for v√°lida e diferente da URL atual
                    if (destino && destino.startsWith('http') && destino !== window.location.href) {
                        console.log('üöÄ Redirecionando para URL do Tunnel:', destino);
                        window.location.replace(destino); 
                    }
                } catch (err) {
                    console.error('Erro ao carregar link do Tunnel (Comportamento normal no GitHub Pages):', err.message);
                }
            })();
        }

        // Atrasamos a execu√ß√£o em 500ms para dar tempo ao Service Worker e ao Manifest carregar
        setTimeout(executeRedirection, 500); 
    </script>
</head>
<body>
    <header class="app-header">
        <h1>GK Suplementos - Sistema de Vendas</h1>
    </header>
    <main>
        <div class="box">
            <p>Seja bem-vindo ao PWA de Vendas. Carregando dados...</p>
            </div>
    </main>
    
    <script src="acompanhamento-vendas.js"></script>
</body>
</html>
